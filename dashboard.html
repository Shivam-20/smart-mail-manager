<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartMail AI - Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .header {
            background: #4285f4;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .btn {
            background: #4285f4;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #357ae8;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .email-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #fafafa;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ SmartMail AI Dashboard</h1>
        <p id="userInfo">Loading user info...</p>
    </div>

    <div class="container">
        <div class="stats">
            <div class="stat-card">
                <h3>üìß Total Emails</h3>
                <p id="emailCount">-</p>
            </div>
            <div class="stat-card">
                <h3>üè∑Ô∏è Labels</h3>
                <p id="labelCount">-</p>
            </div>
            <div class="stat-card">
                <h3>ü§ñ Processed</h3>
                <p id="processedCount">-</p>
            </div>
        </div>

        <div class="section">
            <h2>üîÑ Bulk Organization</h2>
            <button class="btn" onclick="bulkOrganize()" style="background: #fbbc04; color: #000;">üîÑ Organize All Emails</button>
            <button class="btn" onclick="analyzeLabels()" style="background: #ea4335; margin-left: 5px;">üîç Analyze Labels</button>
            <div id="bulkResults" style="margin-top: 15px;"></div>
        </div>

        <div class="section">
            <h2>üìß Email Management</h2>
            <div style="margin-bottom: 10px;">
                <button class="btn" onclick="fetchEmails()">üì¨ Fetch Emails</button>
                <button class="btn" onclick="fetchLabels()" style="margin-left: 5px;">üè∑Ô∏è Fetch Labels</button>
                <button class="btn" onclick="testCategorization()" style="margin-left: 5px;">ü§ñ Test Categorization</button>
                <select id="pageSize" onchange="changePageSize()" style="margin-left: 10px; padding: 5px;">
                    <option value="20">20 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                </select>
            </div>
            <div style="margin-bottom: 10px;">
                <button class="btn" onclick="createTestLabel()" style="background: #34a853;">‚ûï Create Test Label</button>
            </div>
            <div id="pagination" style="margin: 10px 0; display: none;">
                <button class="btn" onclick="previousPage()" id="prevBtn" disabled>‚¨ÖÔ∏è Previous</button>
                <span style="margin: 0 15px;" id="pageInfo">Page 1</span>
                <button class="btn" onclick="nextPage()" id="nextBtn" disabled>‚û°Ô∏è Next</button>
            </div>
            <div id="bulkActions" style="margin: 10px 0; display: none;">
                <span id="selectionInfo" style="margin-right: 10px;"></span>
                <button class="btn" onclick="categorizeSelected()" style="background: #4285f4;">ü§ñ Categorize Selected</button>
                <button class="btn" onclick="applyLabelToSelected()" style="background: #34a853; margin-left: 5px;">üè∑Ô∏è Apply Label to Selected</button>
                <button class="btn" onclick="clearSelection()" style="background: #ea4335; margin-left: 5px;">‚ùå Clear Selection</button>
            </div>
        </div>

        <div id="status" class="status" style="display: none;"></div>

        <div class="card">
            <h3>üìß Recent Emails</h3>
            <div id="emailList">Click "Fetch Emails" to load your recent emails...</div>
        </div>

        <div class="card">
            <h3>üè∑Ô∏è Your Labels</h3>
            <div id="labelList">Click "Fetch Labels" to load your labels...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:3000';

        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            setTimeout(() => status.style.display = 'none', 5000);
        }

        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/auth/status`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.authenticated) {
                    document.getElementById('userInfo').textContent = 
                        `Welcome, ${data.user.displayName || data.user.email}! üéâ`;
                    showStatus('‚úÖ Successfully authenticated!', 'success');
                } else {
                    document.getElementById('userInfo').textContent = 'Not authenticated';
                    showStatus('‚ùå Not authenticated - redirecting to login...', 'error');
                    setTimeout(() => window.location.href = '/login.html', 2000);
                }
            } catch (error) {
                showStatus(`‚ùå Auth check failed: ${error.message}`, 'error');
            }
        }

        // Pagination and multi-select state management
        let currentPageToken = null;
        let previousPageTokens = [];
        let nextPageToken = null;
        let selectedEmails = new Set();
        let currentPageSize = 20;
        let currentPage = 1;

        async function fetchEmails(pageToken = null) {
            try {
                console.log('üìß Frontend: Fetching emails...');
                const response = await fetch(`${API_BASE}/api/emails?pageToken=${pageToken || ''}&maxResults=${currentPageSize}`, {
                    credentials: 'include'
                });
                
                console.log('üìß Frontend: Response status:', response.status);
                
                const data = await response.json();
                console.log('üìß Frontend: Response data:', data);
                
                // Check if response has error
                if (data.error) {
                    throw new Error(data.error + ': ' + data.details);
                }
                
                // Check if data is array (handle paginated response)
                const emails = data.emails || data;
                if (!Array.isArray(emails)) {
                    console.error('üìß Frontend: Response is not an array:', emails);
                    throw new Error('Server returned non-array response');
                }
                
                // Update pagination state
                currentPageToken = pageToken;
                nextPageToken = data.nextPageToken;
                
                const emailList = document.getElementById('emailList');
                emailList.innerHTML = '';
                
                if (emails.length === 0) {
                    emailList.innerHTML = '<p>No emails found. Gmail API may not be enabled.</p>';
                    return;
                }
                
                // Add select all checkbox
                const selectAllDiv = document.createElement('div');
                selectAllDiv.style.marginBottom = '10px';
                selectAllDiv.innerHTML = `
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="margin-right: 10px;">
                    <label for="selectAll">Select All (${emails.length} emails)</label>
                `;
                emailList.appendChild(selectAllDiv);
                
                emails.forEach(email => {
                    const headers = email.payload ? email.payload.headers : [];
                    const subject = headers.find(h => h.name === 'Subject') ? headers.find(h => h.name === 'Subject').value : 'No Subject';
                    const from = headers.find(h => h.name === 'From') ? headers.find(h => h.name === 'From').value : 'Unknown';
                    const date = headers.find(h => h.name === 'Date') ? headers.find(h => h.name === 'Date').value : '';
                    
                    const emailDiv = document.createElement('div');
                    emailDiv.className = 'email-item';
                    emailDiv.style.display = 'flex';
                    emailDiv.style.alignItems = 'center';
                    emailDiv.innerHTML = `
                        <input type="checkbox" id="email-${email.id}" onchange="toggleEmailSelection('${email.id}')" style="margin-right: 10px;">
                        <div style="flex: 1;">
                            <strong>Subject:</strong> ${subject}<br>
                            <strong>From:</strong> ${from}<br>
                            <strong>Date:</strong> ${new Date(date).toLocaleDateString()}<br>
                            <div style="margin-top: 10px;">
                                <button class="btn" onclick="categorizeEmail('${email.id}', '${subject}', '${from}')" style="background: #4285f4;">ü§ñ Categorize</button>
                                <button class="btn" onclick="applyLabelToEmail('${email.id}', '${subject}', '${from}')" style="background: #34a853; margin-left: 5px;">üè∑Ô∏è Apply Label</button>
                            </div>
                            <div id="category-${email.id}" style="margin-top: 5px; font-size: 14px; color: #666;"></div>
                        </div>
                    `;
                    emailList.appendChild(emailDiv);
                    
                    // Restore selection state
                    if (selectedEmails.has(email.id)) {
                        document.getElementById(`email-${email.id}`).checked = true;
                    }
                });
                
                // Update pagination UI
                updatePaginationUI();
                
                // Update email count
                document.getElementById('emailCount').textContent = emails.length;
                showStatus(`‚úÖ Fetched ${emails.length} emails`, 'success');
            } catch (error) {
                console.error('üìß Frontend: Error fetching emails:', error);
                showStatus(`‚ùå Error fetching emails: ${error.message}`, 'error');
                
                // Show helpful message for Gmail API error
                if (error.message.includes('Gmail API not enabled')) {
                    showStatus('üö® Gmail API not enabled! See enable-gmail-api.md for instructions', 'error');
                }
            }
        }

        function updatePaginationUI() {
            const pagination = document.getElementById('pagination');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageInfo = document.getElementById('pageInfo');
            
            if (nextPageToken || previousPageTokens.length > 0) {
                pagination.style.display = 'block';
                prevBtn.disabled = previousPageTokens.length === 0;
                nextBtn.disabled = !nextPageToken;
                pageInfo.textContent = `Page ${currentPage}`;
            } else {
                pagination.style.display = 'none';
            }
        }

        function previousPage() {
            if (previousPageTokens.length > 0) {
                const prevToken = previousPageTokens.pop();
                currentPage--;
                fetchEmails(prevToken);
            }
        }

        function nextPage() {
            if (nextPageToken) {
                previousPageTokens.push(currentPageToken);
                currentPage++;
                fetchEmails(nextPageToken);
            }
        }

        function changePageSize() {
            const pageSize = document.getElementById('pageSize').value;
            currentPageSize = parseInt(pageSize);
            currentPage = 1;
            previousPageTokens = [];
            nextPageToken = null;
            fetchEmails();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('[id^="email-"]');
            
            checkboxes.forEach(checkbox => {
                const emailId = checkbox.id.replace('email-', '');
                checkbox.checked = selectAll.checked;
                
                if (selectAll.checked) {
                    selectedEmails.add(emailId);
                } else {
                    selectedEmails.delete(emailId);
                }
            });
            
            updateBulkActionsUI();
        }

        function toggleEmailSelection(emailId) {
            const checkbox = document.getElementById(`email-${emailId}`);
            
            if (checkbox.checked) {
                selectedEmails.add(emailId);
            } else {
                selectedEmails.delete(emailId);
            }
            
            updateBulkActionsUI();
        }

        function updateBulkActionsUI() {
            const bulkActions = document.getElementById('bulkActions');
            const selectionInfo = document.getElementById('selectionInfo');
            
            if (selectedEmails.size > 0) {
                bulkActions.style.display = 'block';
                selectionInfo.textContent = `${selectedEmails.size} email${selectedEmails.size > 1 ? 's' : ''} selected`;
            } else {
                bulkActions.style.display = 'none';
            }
        }

        function clearSelection() {
            selectedEmails.clear();
            document.getElementById('selectAll').checked = false;
            
            const checkboxes = document.querySelectorAll('[id^="email-"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            updateBulkActionsUI();
        }

        async function categorizeSelected() {
            if (selectedEmails.size === 0) {
                showStatus('‚ùå No emails selected', 'error');
                return;
            }
            
            try {
                console.log('ü§ñ Frontend: Categorizing selected emails...');
                showStatus(`ü§ñ Categorizing ${selectedEmails.size} selected emails...`, 'info');
                
                const response = await fetch(`${API_BASE}/api/bulk-operations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        emailIds: Array.from(selectedEmails),
                        operation: 'categorize'
                    })
                });
                
                const result = await response.json();
                console.log('ü§ñ Frontend: Bulk categorization result:', result);
                
                showStatus(`‚úÖ Categorized ${result.successful} emails, ${result.failed} failed`, 'success');
                clearSelection();
                
            } catch (error) {
                console.error('ü§ñ Frontend: Error in bulk categorization:', error);
                showStatus(`‚ùå Error categorizing emails: ${error.message}`, 'error');
            }
        }

        async function applyLabelToSelected() {
            if (selectedEmails.size === 0) {
                showStatus('‚ùå No emails selected', 'error');
                return;
            }
            
            // Ask user for category
            const category = prompt('Enter category to apply (e.g., Finance/Investments, Work, Personal):');
            if (!category) return;
            
            try {
                console.log('üè∑Ô∏è Frontend: Applying label to selected emails...');
                showStatus(`üè∑Ô∏è Applying label "${category}" to ${selectedEmails.size} emails...`, 'info');
                
                const response = await fetch(`${API_BASE}/api/bulk-operations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        emailIds: Array.from(selectedEmails),
                        operation: 'applyLabel',
                        category: category
                    })
                });
                
                const result = await response.json();
                console.log('üè∑Ô∏è Frontend: Bulk label application result:', result);
                
                showStatus(`‚úÖ Applied labels to ${result.successful} emails, ${result.failed} failed`, 'success');
                clearSelection();
                
            } catch (error) {
                console.error('üè∑Ô∏è Frontend: Error in bulk label application:', error);
                showStatus(`‚ùå Error applying labels: ${error.message}`, 'error');
            }
        }

        async function fetchLabels() {
            try {
                console.log('üè∑Ô∏è Frontend: Fetching labels...');
                const response = await fetch(`${API_BASE}/api/labels`, {
                    credentials: 'include'
                });
                
                console.log('üè∑Ô∏è Frontend: Response status:', response.status);
                
                const data = await response.json();
                console.log('üè∑Ô∏è Frontend: Response data:', data);
                
                // Check if response has error
                if (data.error) {
                    throw new Error(data.error + ': ' + data.details);
                }
                
                // Check if data is array (handle error responses that include labels array)
                const labels = data.labels || data;
                if (!Array.isArray(labels)) {
                    console.error('üè∑Ô∏è Frontend: Response is not an array:', labels);
                    throw new Error('Server returned non-array response');
                }
                
                const labelList = document.getElementById('labelList');
                labelList.innerHTML = '';
                
                if (labels.length === 0) {
                    labelList.innerHTML = '<p>No labels found. Gmail API may not be enabled.</p>';
                    return;
                }
                
                labels.forEach(label => {
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'email-item';
                    labelDiv.innerHTML = `
                        <strong>Name:</strong> ${label.name}<br>
                        <strong>ID:</strong> ${label.id}<br>
                        <strong>Type:</strong> ${label.type}
                    `;
                    labelList.appendChild(labelDiv);
                });
                
                document.getElementById('labelCount').textContent = labels.length;
                showStatus(`‚úÖ Fetched ${labels.length} labels`, 'success');
            } catch (error) {
                console.error('üè∑Ô∏è Frontend: Error fetching labels:', error);
                showStatus(`‚ùå Error fetching labels: ${error.message}`, 'error');
                
                // Show helpful message for Gmail API error
                if (error.message.includes('Gmail API not enabled')) {
                    showStatus('üö® Gmail API not enabled! See enable-gmail-api.md for instructions', 'error');
                }
            }
        }

        async function createTestLabel() {
            const labelName = prompt('Enter label name:');
            if (!labelName) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/labels`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ name: labelName })
                });
                
                if (response.ok) {
                    showStatus(`‚úÖ Created label: ${labelName}`, 'success');
                    fetchLabels();
                } else {
                    throw new Error('Failed to create label');
                }
            } catch (error) {
                showStatus(`‚ùå Error creating label: ${error.message}`, 'error');
            }
        }

        async function categorizeEmail(emailId, subject, from) {
            try {
                console.log('ü§ñ Frontend: Categorizing email:', { emailId, subject, from });
                const response = await fetch(`${API_BASE}/api/categorize-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ subject, from })
                });
                
                const result = await response.json();
                console.log('ü§ñ Frontend: Categorization result:', result);
                
                // Show category in the UI
                const categoryDiv = document.getElementById(`category-${emailId}`);
                if (categoryDiv) {
                    categoryDiv.innerHTML = `<strong>üè∑Ô∏è Suggested:</strong> ${result.category} <span style="color: #999;">(${result.source})</span>`;
                }
                
                showStatus(`ü§ñ Categorized as: ${result.category}`, 'success');
                document.getElementById('processedCount').textContent = 
                    parseInt(document.getElementById('processedCount').textContent || '0') + 1;
            } catch (error) {
                console.error('ü§ñ Frontend: Error categorizing email:', error);
                showStatus(`‚ùå Error categorizing email: ${error.message}`, 'error');
            }
        }

        async function applyLabelToEmail(emailId, subject, from) {
            try {
                console.log('üè∑Ô∏è Frontend: Applying label to email:', { emailId, subject, from });
                
                // First categorize if not already done
                let category;
                const categoryDiv = document.getElementById(`category-${emailId}`);
                
                if (categoryDiv && categoryDiv.textContent.includes('Suggested:')) {
                    // Extract category from existing suggestion
                    const match = categoryDiv.textContent.match(/Suggested:\s*([^\s]+)/);
                    category = match ? match[1] : 'Other';
                } else {
                    // Categorize first
                    const categorizeResponse = await fetch(`${API_BASE}/api/categorize-email`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({ subject, from })
                    });
                    
                    const categorizeResult = await categorizeResponse.json();
                    category = categorizeResult.category;
                    
                    // Show category in UI
                    if (categoryDiv) {
                        categoryDiv.innerHTML = `<strong>üè∑Ô∏è Suggested:</strong> ${category} <span style="color: #999;">(${categorizeResult.source})</span>`;
                    }
                }
                
                // Apply the label
                const applyResponse = await fetch(`${API_BASE}/api/apply-label`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ emailId, category })
                });
                
                const applyResult = await applyResponse.json();
                console.log('üè∑Ô∏è Frontend: Apply label result:', applyResult);
                
                if (applyResult.success) {
                    // Update UI to show label applied
                    if (categoryDiv) {
                        categoryDiv.innerHTML = `<strong>‚úÖ Label Applied:</strong> ${category} <span style="color: #34a853;">(in Gmail)</span>`;
                    }
                    
                    showStatus(`üè∑Ô∏è Applied label "${category}" to email in Gmail!`, 'success');
                    
                    // Update synced count
                    document.getElementById('processedCount').textContent = 
                        parseInt(document.getElementById('processedCount').textContent || '0') + 1;
                } else {
                    throw new Error(applyResult.error || 'Failed to apply label');
                }
                
            } catch (error) {
                console.error('üè∑Ô∏è Frontend: Error applying label:', error);
                showStatus(`‚ùå Error applying label: ${error.message}`, 'error');
            }
        }

        async function testCategorization() {
            try {
                const response = await fetch(`${API_BASE}/api/categorize-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        subject: 'Meeting tomorrow at 3 PM', 
                        from: 'company@example.com' 
                    })
                });
                
                const result = await response.json();
                showStatus(`üß™ Test categorization result: ${result.category}`, 'success');
            } catch (error) {
                showStatus(`‚ùå Error in test: ${error.message}`, 'error');
            }
        }

        async function bulkOrganize() {
            try {
                console.log('üîÑ Frontend: Starting bulk organization...');
                showStatus('üîÑ Starting bulk email organization...', 'info');
                
                const bulkResults = document.getElementById('bulkResults');
                bulkResults.innerHTML = '<div style="color: #fbbc04;">‚è≥ Processing emails... This may take a few minutes.</div>';
                
                const response = await fetch(`${API_BASE}/api/bulk-organize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                const result = await response.json();
                console.log('üîÑ Frontend: Bulk organization result:', result);
                
                if (result.successful > 0) {
                    // Display grouped results
                    let groupedHtml = '<h4>üìä Organization Results:</h4>';
                    Object.entries(result.grouped).forEach(([category, count]) => {
                        groupedHtml += `<div style="margin: 5px 0;">üè∑Ô∏è ${category}: ${count} emails</div>`;
                    });
                    
                    groupedHtml += `
                        <div style="margin-top: 10px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                            ‚úÖ <strong>Success:</strong> ${result.successful} emails categorized<br>
                            ${result.failed > 0 ? `‚ùå <strong>Failed:</strong> ${result.failed} emails` : ''}
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn" onclick="bulkApplyLabels()" style="background: #34a853;">üè∑Ô∏è Apply All Labels to Gmail</button>
                        </div>
                    `;
                    
                    bulkResults.innerHTML = groupedHtml;
                    showStatus(`‚úÖ Bulk organization complete: ${result.successful} emails categorized`, 'success');
                    
                    // Update processed count
                    document.getElementById('processedCount').textContent = result.successful;
                } else {
                    bulkResults.innerHTML = '<div style="color: #666;">‚ÑπÔ∏è No new emails to organize</div>';
                    showStatus('‚ÑπÔ∏è No uncategorized emails found', 'info');
                }
                
            } catch (error) {
                console.error('üîÑ Frontend: Error in bulk organization:', error);
                showStatus(`‚ùå Error in bulk organization: ${error.message}`, 'error');
                document.getElementById('bulkResults').innerHTML = '<div style="color: #ea4335;">‚ùå Organization failed</div>';
            }
        }

        async function analyzeLabels() {
            try {
                console.log('üîç Frontend: Analyzing Gmail labels...');
                showStatus('üîç Analyzing your Gmail labels...', 'info');
                
                const response = await fetch(`${API_BASE}/api/labels/analysis`, {
                    credentials: 'include'
                });
                
                const result = await response.json();
                console.log('üîç Frontend: Label analysis result:', result);
                
                const analysis = result.analysis;
                let analysisHtml = `
                    <h4>üìä Label Analysis:</h4>
                    <div><strong>Total Labels:</strong> ${analysis.total}</div>
                    <div><strong>User Labels:</strong> ${analysis.userLabels}</div>
                    <div><strong>System Labels:</strong> ${analysis.systemLabels}</div>
                `;
                
                if (analysis.potentialDuplicates.length > 0) {
                    analysisHtml += `<div style="margin-top: 10px;"><strong>‚ö†Ô∏è Potential Duplicates:</strong></div>`;
                    analysis.potentialDuplicates.forEach(label => {
                        analysisHtml += `<div style="margin-left: 20px; color: #ea4335;">‚Ä¢ ${label}</div>`;
                    });
                }
                
                if (analysis.nonHierarchical.length > 0) {
                    analysisHtml += `<div style="margin-top: 10px;"><strong>üí° Could Be Hierarchical:</strong></div>`;
                    analysis.nonHierarchical.forEach(label => {
                        analysisHtml += `<div style="margin-left: 20px; color: #fbbc04;">‚Ä¢ ${label}</div>`;
                    });
                }
                
                if (analysis.suggestions.length > 0) {
                    analysisHtml += `<div style="margin-top: 10px;"><strong>üí° Suggestions:</strong></div>`;
                    analysis.suggestions.forEach(suggestion => {
                        analysisHtml += `<div style="margin-left: 20px; color: #4285f4;">‚Ä¢ ${suggestion}</div>`;
                    });
                }
                
                document.getElementById('bulkResults').innerHTML = analysisHtml;
                showStatus('‚úÖ Label analysis complete', 'success');
                
            } catch (error) {
                console.error('üîç Frontend: Error analyzing labels:', error);
                showStatus(`‚ùå Error analyzing labels: ${error.message}`, 'error');
            }
        }

        async function bulkApplyLabels() {
            try {
                console.log('üè∑Ô∏è Frontend: Bulk applying labels to Gmail...');
                showStatus('üè∑Ô∏è Applying labels to Gmail... This may take a few minutes.', 'info');
                
                // Get all categorized emails from database
                const response = await fetch(`${API_BASE}/api/db/emails`, {
                    credentials: 'include'
                });
                
                const emails = await response.json();
                const uncategorizedEmails = emails.filter(email => email.category && email.category !== 'Other' && !email.synced);
                
                console.log(`üè∑Ô∏è Found ${uncategorizedEmails.length} emails to label`);
                
                let successCount = 0;
                let failCount = 0;
                
                // Process in batches to respect rate limits
                const batchSize = 5;
                for (let i = 0; i < uncategorizedEmails.length; i += batchSize) {
                    const batch = uncategorizedEmails.slice(i, i + batchSize);
                    
                    for (const email of batch) {
                        try {
                            const applyResponse = await fetch(`${API_BASE}/api/apply-label`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                credentials: 'include',
                                body: JSON.stringify({ 
                                    emailId: email.id, 
                                    category: email.category 
                                })
                            });
                            
                            const applyResult = await applyResponse.json();
                            if (applyResult.success) {
                                successCount++;
                            } else {
                                failCount++;
                            }
                        } catch (error) {
                            console.error(`‚ùå Failed to apply label to ${email.id}:`, error);
                            failCount++;
                        }
                    }
                    
                    // Add delay between batches
                    if (i + batchSize < uncategorizedEmails.length) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
                
                showStatus(`üè∑Ô∏è Bulk label application complete: ${successCount} successful, ${failCount} failed`, 'success');
                
                // Update bulk results
                const bulkResults = document.getElementById('bulkResults');
                bulkResults.innerHTML += `
                    <div style="margin-top: 10px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                        ‚úÖ <strong>Labels Applied:</strong> ${successCount} emails now organized in Gmail<br>
                        ${failCount > 0 ? `‚ùå <strong>Failed:</strong> ${failCount} emails` : ''}
                    </div>
                `;
                
            } catch (error) {
                console.error('üè∑Ô∏è Frontend: Error in bulk label application:', error);
                showStatus(`‚ùå Error applying labels: ${error.message}`, 'error');
            }
        }

        function logout() {
            window.location.href = `${API_BASE}/auth/logout`;
        }

        // Initialize on page load
        window.onload = () => {
            checkAuth();
            document.getElementById('processedCount').textContent = '0';
        };
    </script>
</body>
</html>
